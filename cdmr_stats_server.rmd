---
title: "cmdr stats server"
author: "Guy Schnidrig"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  flexdashboard::flex_dashboard:
    theme: flatly
    orientation: columns
    vertical_layout: fill

runtime: shiny
---

```{r global, setup, include = FALSE, echo = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Load Libraries
library(tidyverse)
library(plotly)
library(readxl)
library(flextable)
library(shiny)
library(flexdashboard)
library(jsonlite)
library(httr)
library(data.table)
library(dtplyr)
library(googlesheets4)
library(RColorBrewer)
library(png)
library(broom)
library(dotwhisker)
library(ggplot2)
library(cowplot)
library(magick)

# Misc
Sys.setenv(LANG = "en")
rm(list=ls())
gc()
set.seed(42)
options(scipen = 999,
        dplyr.summarise.inform = FALSE)

# Authenticate using token. 
gs4_auth(cache = ".secrets", email = "g.schnidu@gmail.com")

# Write to sheet
#ss <- gs4_get("https://docs.google.com/spreadsheets/d/1yMb2ijZfeAcAVHBNJGTcnORYu4GPSBTlDTioDQkoB1c/edit#gid=1318392544")
#sheet_append(ss, data.frame(time=Sys.time()))



# Game Data
data <- read_sheet("https://docs.google.com/spreadsheets/d/1yMb2ijZfeAcAVHBNJGTcnORYu4GPSBTlDTioDQkoB1c/edit#gid=1318392544")

color_list <- hcl.colors(length(unique(data$Player)), "Set 2")

data$color <- leaflet::colorFactor(
  palette = color_list, domain = unique(data$Player)
  )(data$Player)

player_color_mapping <- data %>% 
  group_by(Player) %>%
  reframe(color = color) %>% 
  distinct(Player, .keep_all = T) %>% 
  ungroup()
```

```{r data setup, include = FALSE, echo = FALSE, warning = FALSE}
# Set Deck ID
data <- data %>%
  group_by(Deck_Link) %>%
  mutate(Deck_ID = cur_group_id()) %>%
  ungroup()

# Set Factors
cols <- c("Game_ID","Game_Type", "Player", "Commander", "Colors", "Win_Type", "MV_Card", "Deck_ID")
data[cols] <- lapply(data[cols], factor)

# Set Date
data$Date <- lubridate::dmy(data$Date)

# Get Deck links
deck_list <- data %>%
  filter(grepl("archidekt", Deck_Link)) %>%
  select(Deck_Link, Deck_ID) %>%
  distinct(Deck_Link, Deck_ID)

# Add right api path and ending
deck_list$Deck_Link <- deck_list$Deck_Link %>%
  str_replace(.,"decks", "api/decks") %>%
  str_replace(.,"www.", "") %>%
  gsub("#.*", "", .)

deck_list <- deck_list %>%
  mutate(Deck_Link_clean = paste0(Deck_Link,"/")) %>%
  select(-Deck_Link) %>% 
  distinct()

data <- left_join(data, deck_list, by = "Deck_ID") 

# Get Deck lists
res_list <- lapply(deck_list$Deck_Link_clean, httr::GET)
json_text_list <- lapply(res_list, content, as = "text", encoding = "UTF-8") 
json_data_list <- lapply(json_text_list, fromJSON)

counter <- 1
quantity_list <- lapply(json_data_list, function(i) {
  x = i$cards$quantity 
  z = i$cards$card$oracleCard$cmc
  g = i$cards$card$oracleCard$salt
  p = i$cards$card$prices$tcg
  n = i$cards$card$oracleCard$name
  c = i$cards$card$oracleCard$defaultCategory
  t = i$cards$card$oracleCard$types
  s = i$cards$card$oracleCard$superTypes
  d = i$name
  m = i$cards$categories
  counter <<- counter + 1
  name <- tibble(d,n,x,z,g,p,t,s,c,m) %>%
  rename(deck_name = d,
         card_name = n,
         Quantity = x,
         cmc = z,
         salt = g,
         price = p,
         type = t,
         super_type = s,
         category = c,
         maybe = m)  %>%
    filter(!str_detect(m, "Maybeboard")) %>% 
  mutate(Deck_Link_clean = deck_list$Deck_Link_clean[counter])
  })

commander_decks <- quantity_list

# rename the list items
names(commander_decks) <- c(deck_list$Deck_Link_clean)


# Create data frame with all decks
all_decks <- data.table::rbindlist(commander_decks)

deck_infos <- data %>%
   select(Deck_Link_clean, Commander, Player, Deck_ID) %>% 
  distinct() %>% 
  drop_na()

all_decks_join <- left_join(all_decks, deck_infos, by = "Deck_Link_clean")

all_decks_join <- all_decks_join %>%
  group_by(Player) %>%
  mutate(Number_of_decks = length(unique(Deck_ID))) %>% 
  ungroup()


# Handle Types
all_decks_join <- all_decks_join %>% 
  mutate(basic_land = case_when(super_type == "Basic" & type == "Land" ~ 1 ,
                                TRUE ~ 0))
# Split types
all_decks_join <- all_decks_join %>%
  separate(type, into = c("type_1", "type_2"), sep = " ", fill = "right")
  
# Define the pattern you want to remove
pattern_1 = 'c\\("'
pattern_2 = '\",'
pattern_3 = '\"'
pattern_4 = '\\)'

# Remove the pattern 
all_decks_join$type_1 <- gsub(pattern_1, '', all_decks_join$type_1)
all_decks_join$type_1 <- gsub(pattern_2, '', all_decks_join$type_1)
all_decks_join$type_2 <- gsub(pattern_3, '', all_decks_join$type_2)
all_decks_join$type_2 <- gsub(pattern_4, '', all_decks_join$type_2)

# Make regression data frame
deck_summary <- all_decks_join %>% 
#  filter(Deck_ID == 4) %>% 
  group_by(Deck_ID, Player) %>% 
  summarise(Average_cmc = mean(cmc[cmc != 0], na.rm = T),
            Salt_Score = sum(salt, na.rm = T),
            Artifacts = sum(Quantity[type_1 == "Artifact" | type_2  == "Artifact"], na.rm = T),
            Creatures = sum(Quantity[type_1 == "Creature" | type_2  == "Creature"], na.rm = T),
            Ramp = sum(Quantity[category == "Ramp"], na.rm = T),
            Draw = sum(Quantity[category == "Draw"], na.rm = T),
            Removal = sum(Quantity[category == "Removal"], na.rm = T),
            Protection = sum(Quantity[category == "Protection"], na.rm = T),
            Tutor = sum(Quantity[category == "Tutor"], na.rm = T),
            Finisher = sum(Quantity[category == "Finisher"], na.rm = T),
            Basic_lands = sum(Quantity[basic_land == 1], na.rm = T),
            Deck_price = sum(price, na.rm = T))

# Join deck summary
data <- left_join(data, deck_summary, by = join_by(Player, Deck_ID))

# Fill up Win turn
data <- data %>% 
  group_by(Game_ID) %>% 
  fill(Win_Turn, .direction = "updown") %>% 
  ungroup()

```

# Dashboard

## Column {data-width="650"}

### Games played

```{r, echo = FALSE}
ggplotly(
  data %>%
  filter(Game_Type != "Draft") %>%
  group_by(Player) %>%
  summarise(Played_Games = length(Game_ID)) %>%
  ggplot(aes(x = reorder(Player,-Played_Games), y = Played_Games, fill = Player)) +
  geom_bar(stat = "identity") +
  labs(x = "", y = "Games Played") + 
  scale_fill_manual(values = player_color_mapping$color) +
  theme_bw() +
    theme(panel.grid = element_blank())) %>% 
  plotly::config(displayModeBar = F) %>% 
  plotly::layout(xaxis=list(fixedrange=TRUE)) %>% 
  plotly::layout(yaxis=list(fixedrange=TRUE))
```

### Total Games Won

```{r, echo = FALSE}
colors_listed = c( Elie = color_list[1], Guy = color_list[2])



data %>%
  filter(Game_Type != "Draft") %>%
  filter(Win >= 1) %>%
  plot_ly(., 
          labels = ~Player, 
          values = ~Win,
          marker = list(colors = ~color,
                      line = list(color = '#FFFFFF', width = 1)),
          type = 'pie',
          textinfo='label+percent') %>%  
          layout(xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
                 yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))  %>% 
  plotly::config(displayModeBar = F) %>% 
  plotly::layout(xaxis=list(fixedrange=TRUE)) %>% 
  plotly::layout(yaxis=list(fixedrange=TRUE))

```

## Row

### Statistics

```{r, echo = FALSE}
data %>%
  filter(Game_Type != "Draft") %>%
  summarise(`Total Games` = length(unique(Game_ID)),
            `Unique Players` = length(unique(Player)),
            `Unique Commanders` = length(unique(Commander)),
            `Average Win Turn` = round(mean(Win_Turn, na.rm = TRUE),2),
            `Most Played Color Combo` = names(which.max(table(.$Colors)))) %>%
  knitr::kable(align = "l")
```

```{r, echo = FALSE}
most_played_card <- all_decks_join %>% 
  filter(type_1 != "Land", type_1 != "Land", category != "Ramp") %>% 
  group_by(card_name) %>%
  count() %>% 
  ungroup() %>% 
  arrange(desc(n)) %>%
  slice_head(n = 5)


all_decks_join %>%
  filter(type_1 != "Land", type_1 != "Land") %>% 
  #distinct(Deck_ID, .keep_all = TRUE) %>% 
  summarise(`Average cmc` = mean(cmc),
            `Average salt score` = mean(salt, na.rm = T),
            `Average card price` = mean(price, na.rm = T),
            `Most expeinsive card` = max(price)) %>%
  mutate(`1st Popular Card (nonramp)` = most_played_card$card_name[1],
         `2nd Popular Card (nonramp)` = most_played_card$card_name[2],) %>%
  mutate(across(where(is.numeric), round, 2)) %>% 
  knitr::kable(align = "l")
```

```{r, echo = FALSE}
 data %>% 
  filter(Game_Type != "Draft") %>%
  group_by(Commander) %>%
  summarise(`Games played` = length(Commander),
            Wins = sum(Win, na.rm = T)) %>%
  arrange(desc(`Games played`)) %>%
  slice_head(n = 5)%>%
  knitr::kable(align = "l")
```

### Mana Value Distribution of all decks played

```{r,echo=FALSE}
deck_cmc <- all_decks_join %>%
  group_by(Player, cmc, Number_of_decks) %>%
  summarize(Average_Number_Spells = (mean(n_distinct(card_name))))


deck_cmc_average <- deck_cmc %>%
  summarise(Average_Number_Spells = (Average_Number_Spells) / Number_of_decks) %>% 
  left_join(., player_color_mapping, by = "Player")

player.cols = c("Aless" = "#ED90A4",
               "Elie" = "#7EBA68",
               "Fubu" = "#1DC199",
               "Guy" = "#00BFC8",
               "Lueku" = "#BB9DEA",
               "Tobi" = "#E48FD1")
 
ggplotly(deck_cmc_average %>%
  filter(cmc > 0, Player != "Lucien") %>%
  ggplot(aes(y = Average_Number_Spells, x = cmc, fill = Player)) +
  geom_bar(position="dodge", stat="identity") + 
    scale_fill_manual(values = player.cols, limits = names(player.cols)) +
    facet_wrap(~Player) + 
    scale_x_continuous(breaks = seq(min(deck_cmc_average$cmc, na.rm = T), max(deck_cmc_average$cmc, na.rm = T), by = 1)) +
    labs(x = "cmc", y = "Average Number Of Spells") +
    theme_bw() +
    theme(panel.grid = element_blank(),
          strip.background = element_rect(colour = "black", fill = "#e3e5d8")))  %>% 
  plotly::config(displayModeBar = F) %>% 
  plotly::layout(xaxis=list(fixedrange=TRUE)) %>% 
  plotly::layout(yaxis=list(fixedrange=TRUE))
```

# Game data

```{r, echo=FALSE}
DT::datatable(data, filter = 'top')
```

# Deck data

```{r, echo=FALSE}
DT::datatable(all_decks_join, filter = 'top')
```

# Graphs

## Column {data-width="650"}

### Games played

```{r, echo = FALSE}
ggplotly(data %>%
           filter(Game_Type != "Draft") %>%  
           group_by(Player) %>%
           summarise(`Played Games` = length(Game_ID)) %>%
           ggplot(aes(x = reorder(Player,-`Played Games`), y = `Played Games`, fill = Player)) +
           geom_bar(stat='identity') +
           scale_fill_manual(values = player_color_mapping$color) +
           labs(x = "", y = "Games Played") +
           theme_bw() +
           theme(panel.grid = element_blank()))  %>% 
  plotly::config(displayModeBar = F) %>% 
  plotly::layout(xaxis=list(fixedrange=TRUE)) %>% 
  plotly::layout(yaxis=list(fixedrange=TRUE))
 
```

### Relative Games Won By Player

```{r RGW, echo=FALSE}
ggplotly(data %>%
           filter(Game_Type != "Draft") %>%
  group_by(Player) %>%
  summarise(
    gl = length(unique(Game_ID)),
Won_games_relative = (sum(Win, na.rm = TRUE) / length(unique(Game_ID)))) %>%
  filter(Won_games_relative != 0) %>% 
  ggplot(aes(x = reorder(Player,-Won_games_relative), y = Won_games_relative, fill = Player)) +
  geom_bar(stat='identity') +
  scale_fill_manual(values = player_color_mapping$color) +
  labs(x = "", y = "Games Won (Relative)") +
  theme_bw() +
    theme(panel.grid = element_blank()))  %>% 
  plotly::config(displayModeBar = F) %>% 
  plotly::layout(xaxis=list(fixedrange=TRUE)) %>% 
  plotly::layout(yaxis=list(fixedrange=TRUE))
```

## Row

### Top 10 Games Won By Commander And Player

```{r Commander, echo=FALSE}
ggplotly(data %>%
           filter(Game_Type != "Draft") %>%
           group_by(Commander, Player) %>%
           summarise(Won_Games = (sum(Win, na.rm = TRUE))) %>%
           filter(Won_Games >= 1) %>% 
           ungroup() %>% 
           arrange(desc(Won_Games)) %>% 
           slice_head(n = 10) %>% 
           ggplot(aes(x = reorder(Commander,-Won_Games), y = Won_Games, fill = Player)) +
           geom_bar(stat='identity') +
           scale_fill_manual(values = player_color_mapping$color) +
           labs(x = "", y = "Games Won") +
           theme_bw() + 
           theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
                 panel.grid = element_blank())) %>% 
  plotly::config(displayModeBar = F) %>% 
  plotly::layout(xaxis=list(fixedrange=TRUE)) %>% 
  plotly::layout(yaxis=list(fixedrange=TRUE))

```

### Top 10 Games Won By Color Combo And Player

```{r Colorwin, echo=FALSE}
ggplotly(data %>%
           filter(Game_Type != "Draft") %>%
           group_by(Colors, Player) %>%
           summarise(Won_Games = (sum(Win, na.rm = TRUE))) %>%
           filter(Won_Games >= 1) %>%
           ungroup() %>% 
           arrange(desc(Won_Games)) %>% 
           slice_head(n = 10) %>% 
           ggplot(aes(x = reorder(Colors,-Won_Games), y = Won_Games, fill = Player)) +
           geom_bar(stat = "identity") +
           scale_fill_manual(values = player_color_mapping$color) +
           labs(x = "", y = "Games Won") +
           theme_bw() + 
           theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
                 panel.grid = element_blank()))  %>% 
  plotly::config(displayModeBar = F) %>% 
  plotly::layout(xaxis=list(fixedrange=TRUE)) %>% 
  plotly::layout(yaxis=list(fixedrange=TRUE))
```

# Player

## Column {.sidebar}

Choose a Player:

```{r slider input, echo=FALSE}
selectInput(
  "Player", label = "Player:",
  choices = c(unique(data$Player)), selected = "Aless")

selectInput(
  "Game_Type", label = "Gametype:",
  choices = c("Normal", "With_Draft") , selected = "Normal")

```

## Column

### Stats

```{r player stats, echo=FALSE}
renderTable({
  data %>%
    filter(Player == input$Player &  Game_Type != ifelse(input$Game_Type == "Normal", "Draft", "")) %>% 
    summarise(`Total Games` = length(unique(Game_ID)),
            `Unique Commanders` = length(unique(Commander)),
            `Average Win Turn` = round(mean(Win_Turn[Win == 1], na.rm = TRUE),2),
            `Most played Color` = names(which.max(table(.$Colors)))) %>% 
    as.data.table() })
```

### Stats 2

```{r player stats2, echo=FALSE}
renderTable({ data %>% 
  filter(Player == input$Player & Game_Type != ifelse(input$Game_Type == "Normal", "Draft", "")) %>%
  group_by(Commander) %>%
  summarise(`Games played` = length(Commander),
            Wins = as.integer(sum(Win, na.rm = T)),
            Winrate = Wins / `Games played`) %>%
  arrange(desc(`Games played`)) %>% 
    as.data.table()})
```

## Row

### Favorite Commander


```{r player image, echo=FALSE}
renderPlot({

    t <- data %>%
      filter(Player == input$Player & Game_Type != ifelse(input$Game_Type == "Normal", "Draft", "")) %>%
      group_by(Commander) %>%
      summarise(`Games played` = n()) %>%
      arrange(desc(`Games played`)) %>%
      slice(1)

    card_name <- as.character(t[[1]])

    scryfall_url <- paste0("https://api.scryfall.com/cards/named?fuzzy=", URLencode(card_name))
    response <- httr::GET(scryfall_url)
    card_info <- httr::content(response, "parsed")
    image_url <- card_info$image_uris$normal


  


ggdraw() + 
  draw_image(image_url) 
})
```

### Mana Value Distribution

```{r Mana Value Distribution, echo=FALSE}
renderPlotly({
    filtered_data <- deck_cmc_average %>%
      filter(cmc > 0) %>%
      filter(Player == input$Player)
    
    if(nrow(filtered_data) == 0) {
      # Return a message or a default plot if no data matches the input
      return(ggplot() + 
               geom_blank() + 
               ggtitle("No data available for the selected player"))
    } else {
      # Proceed with plotting the filtered data
      p <- ggplot(filtered_data, aes(y = Average_Number_Spells, x = cmc, fill = Player)) +
        geom_bar(position="dodge", stat="identity") + 
        scale_x_continuous(breaks = 1:12) +
        labs(x = "cmc", y = "Average number of Spells") +
        theme_bw()
      ggplotly(p)
    }})
```

# Regression Game Data

## Column

### Model 1

```{r regression_1, echo=FALSE}
data_reduced_1 <- data %>% 
  select(Win, Player, Start, Win_Turn)

data_reduced_1$Win <- as.factor(data_reduced_1$Win)
data_reduced_1$Start <- as.factor(data_reduced_1$Start)

model_1 <- glm(formula = Win ~ Player + Start, data = data_reduced_1, family = "binomial")



```

```{r regression_1.2, echo=FALSE}
dwplot(model_1, show_intercept = F,
       dot_args = list(size = 3), whisker_args = list(size = 1)) +
  theme_bw() +
  xlim(-5,5) +
 geom_vline(xintercept = 0,
               colour = "grey60",
               linetype = 2) 

```

### Model 1 Stats

```{r, regression_1.3, echo=FALSE}
glance(model_1) %>%
  knitr::kable()
```

$$\text{glm(formula = } Win \sim Player + Start, \text{ data = } \text{data, family = "binomial")}$$

## Row

### Model 1 Summary

```{r regression_1.4, echo=FALSE}
tidy(model_1) %>%
  knitr::kable(digits = 2)
```

### Model 1 Odds

```{r odds, echo=FALSE}
odds_ratios <- exp(coef(model_1))
conf_intervals <- confint(model_1)

odds_table <- data.frame(
  OddsRatio = odds_ratios,
  LowerCI = conf_intervals[, 1],
  UpperCI = conf_intervals[, 2]
)
odds_table %>%
  knitr::kable(digits = 2) 
```

# Regression Deck Data

## Column

### Model 2

```{r regression_2, echo=FALSE}
data_reduced_2 <- data %>% 
  select(Win, Player, Start, Win_Turn, Average_cmc, Salt_Score, Artifacts, Creatures,
         Ramp, Draw, Removal, Protection, Tutor, Finisher, Basic_lands, Deck_price) %>% 
  drop_na

data_reduced_2$Win <- as.factor(data_reduced_2$Win)
data_reduced_2$Start <- as.factor(data_reduced_2$Start)


data_reduced_2 <- data_reduced_2 %>% 
  mutate_if(is.numeric, scale) %>% 
  filter(Player != "Lucien")

model_2 <- glm(formula = Win ~ Player + Start + Win_Turn + Average_cmc + Salt_Score +
                 Artifacts + Creatures + Ramp + Draw + Removal + Protection + Tutor + 
                 Finisher + Basic_lands + Deck_price, data = data_reduced_2, family = binomial)

tidy(model_2)%>%
  knitr::kable(digits = 2)

glance(model_2) %>%
  knitr::kable(digits = 2)
```

## Row

### Model2 Odds

```{r odds_2, echo=FALSE}
odds_ratios <- exp(coef(model_2))
conf_intervals <- confint(model_2)

odds_table_2 <- data.frame(
  OddsRatio = odds_ratios,
  LowerCI = conf_intervals[, 1],
  UpperCI = conf_intervals[, 2]
)
odds_table_2 %>%
  knitr::kable(digits = 2) 
```
