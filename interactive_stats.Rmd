---
title: "cmdr stats"
author: "Guy Schnidrig"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
  
---


```{r, setup, include = FALSE, echo = FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(plotly)
library(readxl)
library(flextable)
library(shiny)
library(flexdashboard)
library(scryr)
library(jsonlite)
library(data.table)
library(dtplyr)

Sys.setenv(LANG = "en")
rm(list=ls())
gc()
set.seed(42)
options(scipen = 999,
        dplyr.summarise.inform = FALSE)

# Set WD
dir_path_primary <- "G:/Meine Ablage/MTG"
dir_path_fallback <- "G:/My Drive/MTG"

# attempt to set the working directory to the primary file path
tryCatch(
  {
    setwd(dir_path_primary)
    knitr::opts_knit$set(dir_path_primary)
  },
  error = function(e) {
    # if an error occurs, set the working directory to the fallback file path
    message("An error occurred while setting the primary working directory: ", conditionMessage(e))
    message("Setting the fallback working directory instead.")
    setwd(dir_path_fallback)
    knitr::opts_knit$set(dir_path_fallback)
  }
)


# Read Data
data <- read_excel("cmdr.xlsx") %>%
  as_tibble()


# Set Deck ID
data <- data %>%
  group_by(Deck_Link) %>%
  mutate(Deck_ID = cur_group_id()) %>%
  ungroup()

# Set Factors
cols <- c("Game_ID","Player", "Commander", "Colors", "Win_Type", "MV_Card", "Deck_ID")
data[cols] <- lapply(data[cols], factor)

# Set Date
data$Date <- lubridate::dmy(data$Date)

# Get Deck meta Data
deck_list <- data %>%
  filter(grepl("archidekt", Deck_Link)) %>%
  select(Deck_Link)

deck_list$Deck_Link <- deck_list$Deck_Link %>%
  str_replace(.,"decks", "api/decks") %>%
  gsub("#.*", "", .) 

deck_list <- deck_list %>%
  mutate(Deck_Link = paste0(Deck_Link,"/"))


res_list <- lapply(deck_list$Deck_Link, httr::GET)

jsonlite::fromJSON(rawToChar(res_list[[1]]$content))
# Apply fromJSON() to each element in res_list
data_res <- lapply(res_list, function(x) {
  # Extract the content from the response and convert it to a character string
  content <- rawToChar(x$content)
  # Parse the content as JSON
  jsonlite::fromJSON(content)
})

res = httr::GET("https://archidekt.com/api/decks/2633028/")
data_res = fromJSON(rawToChar(res$content))

x = as.integer(data_res$cards$quantity)
y = data_res$cards$card$uid
deckguy <- tibble(x,y) %>%
  rename(Quantity = x,
         id = y)

card_names <- lapply(deckguy$id, scry_card)
list_data  <- Map(as.data.frame, card_names)
datarbind <- rbindlist(list_data, fill=TRUE)
datarbind <- datarbind %>%
  select(id, name, cmc, type_line, color_identity) %>%
  as_tibble()

deck_1 <- left_join(deckguy, datarbind, by ="id")

DT::datatable(deck_1, filter = 'top')

```

# Dashboard

Column {data-width=650}
-----------------------------------------------------------------------

### Games played

```{r, echo = FALSE}
ggplotly(data %>%
  group_by(Player) %>%
  summarise(`Played Games` = length(Game_ID)) %>%
  ggplot(aes(x = reorder(Player,-`Played Games`), y = `Played Games`, fill = Player)) +
  geom_bar(stat='identity') +
  labs(x = "", y = "Games Played") +
  theme_bw())
```

Column {data-width=350}
-----------------------------------------------------------------------

### Statistics

```{r, echo = FALSE}
data %>%
  summarise(`Total Games` = length(unique(Game_ID)),
            `Unique Players` = length(unique(Player)),
            `Unique Commanders` = length(unique(Commander)),
            `Average Win Turn` = mean(Win_Turn, na.rm = TRUE),
            `Most played Color` = names(which.max(table(.$Colors)))) %>%
  knitr::kable()
 
```

```{r, echo = FALSE}
 data %>% 
  group_by(Commander) %>%
  summarise(`Games played` = length(Commander),
            Wins = sum(Win)) %>%
  arrange(desc(`Games played`)) %>%
  slice(1:5) %>%
  knitr::kable()
```


### Mana Value Distribution

```{r,echo=FALSE}
res = httr::GET("https://archidekt.com/api/decks/2633028/")

data_res = fromJSON(rawToChar(res$content))
x = as.integer(data_res$cards$quantity)
y = data_res$cards$card$uid
deckguy <- tibble(x,y) %>%
  rename(Quantity = x,
         id = y)

card_names <- lapply(deckguy$id, scry_card)
list_data  <- Map(as.data.frame, card_names)
datarbind <- rbindlist(list_data, fill=TRUE)
datarbind <- datarbind %>%
  select(id, name, cmc, type_line, color_identity) %>%
  as_tibble()

deck_1 <- left_join(deckguy, datarbind, by ="id")

ggplotly(deck_1 %>%
  filter(cmc > 0) %>%
  ggplot(aes(x = cmc)) +
  geom_histogram(binwidth = 1, fill = "steelblue") +
  scale_x_continuous(breaks = seq(0, length(deck_1$cmc), 1)) +
  theme_bw())
  
```

# Data

```{r, echo=FALSE}

DT::datatable(data, filter = 'top')

```
# Games played {data-navmenu="Graphs"}
```{r, echo = FALSE}
ggplotly(data %>%
  group_by(Player) %>%
  summarise(`Played Games` = length(Game_ID)) %>%
  ggplot(aes(x = reorder(Player,-`Played Games`), y = `Played Games`, fill = Player)) +
  geom_bar(stat='identity') +
  labs(x = "", y = "Games Played") +
  theme_bw())

```


# Total Games Played By Color and Player {data-navmenu="Graphs"}
```{r, echo=FALSE, warning=FALSE}
ggplotly(data %>%
           group_by(Commander, Player) %>%
           summarise(Played_Games = length(Game_ID)) %>%
           ggplot(aes(x = reorder(Commander,-Played_Games), y = Played_Games, fill = Player)) +
           geom_bar(stat='identity') +
           labs(x = "", y = "Games_Played") +
           theme_bw() +
           theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)))
```

# Total Games Played By Color {data-navmenu="Graphs"}
```{r TGPCol, echo=FALSE, warning=FALSE}
ggplotly(data %>%
  group_by(Colors, Player) %>%
  summarise(Played_Games = length(Game_ID)) %>%
  ggplot(aes(x = reorder(Colors,-Played_Games), y = Played_Games, fill = Player)) +
  geom_bar(stat='identity') +
  labs(x = "", y = "Games_Played") +
  theme_bw())
```

# Total Games Won By Player {data-navmenu="Graphs"}
```{r TGW, echo=FALSE}
ggplotly(data %>%
  group_by(Player) %>%
  summarise(Won_games = sum(Win, na.rm = TRUE)) %>%
  ggplot(aes(x = reorder(Player,-Won_games), y = Won_games, fill = Player)) +
  geom_bar(stat='identity') +
  labs(x = "", y = "Games_Won") +
  theme_bw())
```


# Relative Games Won By Player {data-navmenu="Graphs"} 
```{r RGW, echo=FALSE}
ggplotly(data %>%
  group_by(Player) %>%
  summarise(Won_games_relative = (sum(Win, na.rm = TRUE) / length(unique(Game_ID)))) %>%
  ggplot(aes(x = reorder(Player,-Won_games_relative), y = Won_games_relative, fill = Player)) +
  geom_bar(stat='identity') +
  labs(x = "", y = "Games_Won(Relative)") +
  theme_bw())
```

# Total Games Won By Commander And Player {data-navmenu="Graphs"} 
```{r Commander, echo=FALSE}
ggplotly(data %>%
           group_by(Commander, Player) %>%
           summarise(Won_Games = (sum(Win, na.rm = TRUE))) %>%
           filter(Won_Games >= 1) %>%
           ggplot(aes(x = reorder(Commander,-Won_Games), y = Won_Games, fill = Player)) +
           geom_bar(stat='identity') +
           labs(x = "", y = "Games_Won") +
           theme_bw() + 
           theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)))

```

# Total Games Won By Color And Player {data-navmenu="Graphs"} 
```{r Colorwin, echo=FALSE}
ggplotly(data %>%
           group_by(Colors, Player) %>%
           summarise(Won_Games = (sum(Win, na.rm = TRUE))) %>%
           filter(Won_Games >= 1) %>%
           ggplot(aes(x = reorder(Colors,-Won_Games), y = Won_Games, fill = Player)) +
           geom_bar(stat = "identity") +
           labs(x = "", y = "Games_Won") +
           theme_bw() + 
           theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)))

```

# Connect Decks Stats
```{r}

```